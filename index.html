<script src="https://cdn.jsdelivr.net/npm/kjua@0.6.0/dist/kjua.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const screens = {
        welcome: document.getElementById('welcome'),
        choose: document.getElementById('choose'),
        payment: document.getElementById('payment')
    };
    const loader = document.getElementById('loader');
    let selected = { name: null, price: 0 };

    const wallets = {
        USDT_TRC20: "TVis1d6QARhWBQ6XZmisD2oSWGnqFM2qzX",
        USDT_ERC20: "0xaacE295640C15344C6a2DC934a3AACcD4e23cc20",
        USDT_SOL: "AVQJ4s1Y9BrtEmnH5WrxPT818YibUJsaR4uU6Aiht647",
        BTC: "bc1qrhqsqsds47hycq0zkpx8fdvwfyu0hey843lz6j",
        ETH: "0xaacE295640C15344C6a2DC934a3AACcD4e23cc20",
        LTC: "LS2Pg4V8AhaQ1FRweGUHfkBxtwFAbJ6Dpy",
        USDC: "0xaacE295640C15344C6a2DC934a3AACcD4e23cc20"
    };

    function openScreen(id) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        loader.style.display = 'flex';
        setTimeout(() => {
            loader.style.display = 'none';
            screens[id].classList.add('active');
        }, 900);
    }

    function selectOption(name, price) {
        selected = { name, price };
        document.getElementById('pay_title').innerText = name;
        document.getElementById('price_usdt').innerText = price;
        openScreen('payment');
        
        // Генерируем QR после открытия экрана
        setTimeout(() => {
            updateConversion();
        }, 500);
    }

    async function updateConversion() {
        const cur = document.getElementById("currency").value;

        const qEl = document.getElementById('qrcode');
        qEl.innerHTML = "";

        if (wallets[cur]) {
            const qrSvg = kjua({
                render: 'svg',
                text: wallets[cur],
                size: 250,
                fill: '#6ab2f2',
                back: 'transparent',
                rounded: 1,
                quiet: 1
            });
            qEl.appendChild(qrSvg);
        }

        // show address immediately
        document.getElementById('wallet_address').innerText = wallets[cur] || '—';

        if (cur.startsWith("USDT")) {
            document.getElementById('converted_amount').innerText = `${selected.price} USDT`;
            return;
        }

        try {
            const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,litecoin,usd-coin&vs_currencies=usd");
            const data = await res.json();
            const priceCryptoUSD = {
                BTC: data.bitcoin?.usd || null,
                ETH: data.ethereum?.usd || null,
                LTC: data.litecoin?.usd || null,
                USDC: data["usd-coin"]?.usd || null
            };

            const rate = priceCryptoUSD[cur];
            if (!rate) {
                document.getElementById('converted_amount').innerText = "Курс недоступен";
                return;
            }

            const converted = (selected.price / rate).toFixed(6);
            document.getElementById('converted_amount').innerText = `${converted} ${cur}`;
        } catch (e) {
            console.warn(e);
            document.getElementById('converted_amount').innerText = "Ошибка загрузки курса";
        }
    }

    // кнопка открытия
    document.getElementById('welcomeBtn').addEventListener('click', () => openScreen('choose'));

    // выбор опции
    document.querySelectorAll('#choose .option').forEach(opt => {
        opt.addEventListener('click', () => selectOption(opt.dataset.name, parseFloat(opt.dataset.price)));
    });

    // смена валюты
    document.getElementById('currency').addEventListener('change', updateConversion);

    // копирование адреса
    document.getElementById('copy_address').addEventListener('click', function() {
        const text = document.getElementById('wallet_address').innerText;
        if (!text || text === '—') return;
        navigator.clipboard.writeText(text).then(() => {
            this.classList.add("copied");
            setTimeout(() => this.classList.remove("copied"), 2000);
        }).catch(()=>{ /* ignore */ });
    });

    // прогрессбар + синхронизованный таймер
    const progressBar = document.getElementById("progress");
    for (let i = 0; i < 15; i++) {
        let seg = document.createElement("div");
        seg.classList.add("progress-segment");
        progressBar.appendChild(seg);
    }

    let timerValue = 15;
    setInterval(() => {
        timerValue--;
        if (timerValue < 0) timerValue = 15;
        document.getElementById("timer").innerText = timerValue;

        const segments = document.querySelectorAll(".progress-segment");
        const activeCount = 15 - timerValue;
        segments.forEach((s, i) => {
            s.classList.toggle("active", i < activeCount);
        });
    }, 1000);

    // ПРОМОКОД - ТЕПЕРЬ ВНУТРИ DOMContentLoaded
    const VALID_PROMOS = ["VARLAMOV", "ВАРЛАМОВ", "КАЦ", "KATZ", "ФРОНТ", "СВОБОДА", "SWAP"];
    const DISCOUNTS = {
        "Max Swap Online Card": 22.5,
        "Max Swap NFC Card": 22.5,
        "Max Swap Ultima": 50
    };
    
    const promoInput = document.getElementById("promo_input");
    promoInput.addEventListener('input', () => {
        promoInput.value = promoInput.value.toUpperCase();
    });
    
    const promoBtn = document.getElementById("promo_btn");
    const promoLabel = document.getElementById("promo_label");
    const confettiContainer = document.getElementById("confetti-container");

    promoBtn.addEventListener("click", () => {
        const code = promoInput.value.trim().toUpperCase();

        if (!code) {
            showGlassToast(`
                <div style="text-align:center;">
                   <div><img src="https://github.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/blob/main/Objects/Pencil.webp?raw=true" style="width:70px;"><br>Введите корректный промокод!</div>
                </div>
            `);
            return;
        }

        if (VALID_PROMOS.includes(code)) {
            const discount = DISCOUNTS[selected.name] || 0;
            
            promoLabel.innerHTML = '<img src="https://github.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/blob/main/Symbols/Free%20Button.webp?raw=true" style="width:20px;vertical-align:middle;"> <b> Промокод успешно активирован!</b>';
            promoLabel.classList.add("gold-glow");

            showGlassToast(`
                <div style="text-align:center;">
                    <img src="https://github.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/blob/main/Activity/Party%20Popper.webp?raw=true" style="width:70px;"><br>
                    <div><b>Промокод ${code} успешно принят!</b><br><br> После активации карты на баланс будет дополнительно зачислено <br> ${discount} USD! <br><br> <b>Этот промокод действует 24 часа!</b></div>
                </div>
            `);

            launchConfetti();
        } else {
            promoLabel.innerHTML = '<img src="https://github.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/blob/main/Activity/Ticket.webp?raw=true" style="width:20px; vertical-align:middle"> <b>Есть промокод? Введи его ниже!</b>';
            promoLabel.classList.remove("gold-glow");

            showGlassToast(`
                <div style="text-align:center;">
                    <img src="https://github.com/Tarikul-Islam-Anik/Telegram-Animated-Emojis/blob/main/Symbols/Cross%20Mark.webp?raw=true" style="width:70px;"> <br>
                    <div>Введён некорректный промокод!</div>
                </div>
            `, 2000);
        }
    });

    // стеклянный тултип
    let toast = null;
    function showGlassToast(htmlContent, duration = 0) {
        if (toast) toast.remove();

        toast = document.createElement("div");
        toast.className = "tooltip-glass";
        toast.innerHTML = htmlContent;
        document.body.appendChild(toast);

        function close() {
            if (toast) toast.remove();
            toast = null;
            document.removeEventListener("pointerdown", close);
            if (timeoutId) clearTimeout(timeoutId);
        }

        let timeoutId = null;
        if (duration > 0) {
            timeoutId = setTimeout(close, duration);
        } else {
            setTimeout(() => {
                document.addEventListener("pointerdown", close);
            }, 30);
        }
    }

    // конфетти
    function launchConfetti() {
        confettiContainer.innerHTML = "";

        for (let i = 0; i < 90; i++) {
            const c = document.createElement("div");
            c.className = "confetti-piece";

            const colors = ["#ff4757", "#ffa502", "#2ed573", "#1e90ff", "#ff6b81"];
            c.style.background = colors[Math.floor(Math.random() * colors.length)];

            c.style.left = (Math.random() * 100) + "%";
            c.style.top = "100%";

            confettiContainer.appendChild(c);

            const dx = (Math.random() - 0.5) * 600;
            const dy = -600 - Math.random() * 400;

            c.animate([
                { transform: "translate(0,0) rotate(0deg)", opacity: 1 },
                { transform: `translate(${dx}px, ${dy}px) rotate(360deg)`, opacity: 0 }
            ], {
                duration: 3200 + Math.random() * 700,
                easing: "cubic-bezier(.2,.7,.2,1)"
            });

            setTimeout(() => c.remove(), 5000);
        }
    }

    // тултипы для статуса
    document.querySelectorAll('.tooltip').forEach(t => {
        t.addEventListener('click', function(e) {
            const tooltipText = this.querySelector('.tooltiptext');
            this.classList.add('show');
            setTimeout(() => {
                this.classList.remove('show');
            }, 9000);
        });
    });

}); // КОНЕЦ DOMContentLoaded

// Слайдшоу (оставляем снаружи, т.к. работает независимо)
const slides = document.querySelectorAll(".slide");
let index = 0;
const total = slides.length;

function nextSlide() {
    const current = slides[index];
    current.classList.remove("active");
    current.classList.add("out");

    index = (index + 1) % total;
    const next = slides[index];
    next.classList.remove("out");
    next.classList.add("active");
}

setInterval(nextSlide, 3000);

</script>
